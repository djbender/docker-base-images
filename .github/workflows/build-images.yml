name: Build Images

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch: {}

permissions:
  contents: read

env:
  REGISTRY: ghcr.io
  IMAGE_OWNER: djbender

jobs:
  set-matrix:
    runs-on: ubuntu-latest
    outputs:
      core_matrix: ${{ steps.set-matrix.outputs.core_matrix }}
      common_matrix: ${{ steps.set-matrix.outputs.common_matrix }}
      core_merge_matrix: ${{ steps.set-matrix.outputs.core_merge_matrix }}
      common_merge_matrix: ${{ steps.set-matrix.outputs.common_merge_matrix }}
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          persist-credentials: false

      - uses: ruby/setup-ruby@v1.288.0
        with:
          ruby-version: .ruby-version
          bundler-cache: true

      - name: Set matrix output
        id: set-matrix
        run: |
          echo ${{ github.ref }}
          core_matrix=$(bundle exec rake ci:set-matrix:core)
          echo "$core_matrix" | jq .
          echo "core_matrix=$core_matrix" >> $GITHUB_OUTPUT

          common_matrix=$(bundle exec rake ci:set-matrix:common)
          echo "$common_matrix" | jq .
          echo "common_matrix=$common_matrix" >> $GITHUB_OUTPUT

          core_merge_matrix=$(bundle exec rake ci:set-matrix:core-merge)
          echo "$core_merge_matrix" | jq .
          echo "core_merge_matrix=$core_merge_matrix" >> $GITHUB_OUTPUT

          common_merge_matrix=$(bundle exec rake ci:set-matrix:common-merge)
          echo "$common_merge_matrix" | jq .
          echo "common_merge_matrix=$common_merge_matrix" >> $GITHUB_OUTPUT

  build-core-images:
    runs-on: ${{ matrix.runner }}
    needs:
      - set-matrix
    permissions:
      packages: write
      contents: read
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.set-matrix.outputs.core_matrix) }}
    timeout-minutes: 20
    steps:
      - name: set PWD environment variable
        run: echo "PWD=$(pwd)" >> $GITHUB_ENV

      - uses: actions/checkout@v6.0.2
        with:
          persist-credentials: false

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3.12.0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push primary images
        uses: docker/bake-action@v6.10.0
        with:
          pull: true
          push: ${{ github.ref == 'refs/heads/main' }}
          files: ${{ matrix.bake }}
          targets: ${{ matrix.primary_target }}
          source: .
          set: |
            ${{ matrix.primary_cache_from }}
            ${{ matrix.primary_cache_to }}
            *.platform=${{ matrix.platform }}
            *.tags=${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ matrix.primary_target }}:${{ matrix.version }}-${{ github.run_id }}-${{ matrix.arch }}

      - name: Build and push dev images
        uses: docker/bake-action@v6.10.0
        with:
          pull: true
          push: ${{ github.ref == 'refs/heads/main' }}
          files: ${{ matrix.bake }}
          targets: ${{ matrix.dev_target }}
          source: .
          set: |
            ${{ matrix.dev_cache_from }}
            ${{ matrix.dev_cache_to }}
            *.platform=${{ matrix.platform }}
            *.tags=${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ matrix.primary_target }}:${{ matrix.version }}-dev-${{ github.run_id }}-${{ matrix.arch }}

  merge-core-manifests:
    runs-on: ubuntu-slim
    needs:
      - set-matrix
      - build-core-images
    if: github.ref == 'refs/heads/main'
    permissions:
      packages: write
      contents: read
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.set-matrix.outputs.core_merge_matrix) }}
    env:
      IMAGE_BASE: ghcr.io/djbender/${{ matrix.primary_target }}:${{ matrix.version }}
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create multi-arch manifests
        run: |
          create_manifest() {
            local tag=$1 suffix=$2
            echo "Creating manifest for $tag"
            docker buildx imagetools create -t "$tag" \
              "${IMAGE_BASE}${suffix}-${{ github.run_id }}-amd64" \
              "${IMAGE_BASE}${suffix}-${{ github.run_id }}-arm64"
          }
          for tag in ${{ matrix.primary_tags }}; do create_manifest "$tag" ""; done
          for tag in ${{ matrix.dev_tags }}; do create_manifest "$tag" "-dev"; done

  build-common-images:
    runs-on: ${{ matrix.runner }}
    needs:
      - set-matrix
      - build-core-images
    permissions:
      packages: write
      contents: read
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.set-matrix.outputs.common_matrix) }}
    timeout-minutes: 60
    steps:
      - name: set PWD environment variable
        run: echo "PWD=$(pwd)" >> $GITHUB_ENV

      - uses: actions/checkout@v6.0.2
        with:
          persist-credentials: false

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3.12.0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push primary images
        uses: docker/bake-action@v6.10.0
        with:
          pull: true
          push: ${{ github.ref == 'refs/heads/main' }}
          files: ${{ matrix.bake }}
          targets: ${{ matrix.primary_target }}
          source: .
          set: |
            ${{ matrix.primary_cache_from }}
            ${{ matrix.primary_cache_to }}
            *.platform=${{ matrix.platform }}
            *.tags=${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ matrix.primary_target }}:${{ matrix.version }}-${{ github.run_id }}-${{ matrix.arch }}

      - name: Build and push dev images
        uses: docker/bake-action@v6.10.0
        with:
          pull: true
          push: ${{ github.ref == 'refs/heads/main' }}
          files: ${{ matrix.bake }}
          targets: ${{ matrix.dev_target }}
          source: .
          set: |
            ${{ matrix.dev_cache_from }}
            ${{ matrix.dev_cache_to }}
            *.platform=${{ matrix.platform }}
            *.tags=${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ matrix.primary_target }}:${{ matrix.version }}-dev-${{ github.run_id }}-${{ matrix.arch }}

  merge-common-manifests:
    runs-on: ubuntu-slim
    needs:
      - set-matrix
      - build-common-images
    if: github.ref == 'refs/heads/main'
    permissions:
      packages: write
      contents: read
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.set-matrix.outputs.common_merge_matrix) }}
    env:
      IMAGE_BASE: ghcr.io/djbender/${{ matrix.primary_target }}:${{ matrix.version }}
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create multi-arch manifests
        run: |
          create_manifest() {
            local tag=$1 suffix=$2
            echo "Creating manifest for $tag"
            docker buildx imagetools create -t "$tag" \
              "${IMAGE_BASE}${suffix}-${{ github.run_id }}-amd64" \
              "${IMAGE_BASE}${suffix}-${{ github.run_id }}-arm64"
          }
          for tag in ${{ matrix.primary_tags }}; do create_manifest "$tag" ""; done
          for tag in ${{ matrix.dev_tags }}; do create_manifest "$tag" "-dev"; done

  ci:
    runs-on: ubuntu-slim
    needs:
      - build-core-images
      - build-common-images
      - merge-core-manifests
      - merge-common-manifests
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          results="${{ needs.build-core-images.result }} ${{ needs.build-common-images.result }}"
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            results="$results ${{ needs.merge-core-manifests.result }} ${{ needs.merge-common-manifests.result }}"
          fi
          for result in $results; do
            if [[ "$result" != "success" && "$result" != "skipped" ]]; then
              echo "One or more jobs failed: $results"
              exit 1
            fi
          done
          echo "All jobs passed"
